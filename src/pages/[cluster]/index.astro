---
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';

export const prerender = true;

export async function getStaticPaths() {
  const clusters = await client.fetch(`*[_type == "cluster"]{ "slug": slug.current }`);
  return clusters.map((c: any) => ({
    params: { cluster: c.slug },
  }));
}

const { cluster: slug } = Astro.params;

const clusterData = await client.fetch(`*[_type == "cluster" && slug.current == $slug][0]{
  title,
  description,
  image,
  content
}`, { slug });

if (!clusterData) return Astro.redirect('/404');
---

<Layout title={clusterData.title} description={clusterData.description}>
  <main class="cluster-main">
    <nav class="breadcrumb">
      <a href="/">← Inicio</a>
    </nav>
    
    <header>
      <h1 class="main-title">{clusterData.title}</h1>
      
      {clusterData.image && (
        <img 
          src={urlFor(clusterData.image).width(1200).url()} 
          alt={clusterData.title} 
          class="header-image"
        />
      )}
    </header>

    <section class="description-area">
      <p class="description-text">{clusterData.description}</p>
    </section>

    <article class="rich-text">
      <PortableText value={clusterData.content} />
    </article>

    <hr class="divider" />

    <section class="articles-section">
      <h2 class="section-title">Artículos detallados</h2>
      <div class="grid">
        {slug === 'google-business-profile' && (
          <a href="/google-business-profile/guia-definitiva-de-google-business-profile-domina-el-local-pack-en-2024" class="card-link">
            Guía Definitiva GBP 2024 →
          </a>
        )}
      </div>
    </section>
  </main>
</Layout>

<style>
  .cluster-main { max-width: 850px; margin: 0 auto; padding: 2rem; font-family: system-ui, sans-serif; }
  .breadcrumb a { color: #0070f3; text-decoration: none; font-weight: bold; }
  
  /* Estilo del H1 */
  .main-title { 
    font-size: clamp(2.5rem, 5vw, 3.5rem); 
    font-weight: 800; 
    color: #111; 
    margin-bottom: 1.5rem; 
    line-height: 1.1;
  }

  .header-image { width: 100%; height: auto; border-radius: 16px; margin-bottom: 2.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

  /* Estilo de la descripción (Antes era el segundo H1) */
  .description-area {
    margin-bottom: 3rem;
    padding: 1.5rem 2rem;
    background: #f8faff;
    border-left: 5px solid #0070f3;
    border-radius: 0 12px 12px 0;
  }
  .description-text {
    font-size: 1.3rem;
    line-height: 1.6;
    color: #444;
    font-weight: 500;
    margin: 0;
  }

  .rich-text { font-size: 1.2rem; line-height: 1.8; color: #333; }
  
  /* Seguridad: Si por error hay H1/H2 en el contenido, los estilizamos */
  .rich-text :global(h1), .rich-text :global(h2) {
    font-size: 1.8rem;
    margin-top: 2.5rem;
    color: #111;
    font-weight: 700;
  }

  .divider { margin: 4rem 0; border: 0; border-top: 1px solid #eee; }
  .section-title { font-size: 1.8rem; color: #111; margin-bottom: 1.5rem; }
  .card-link { display: block; padding: 20px; border: 1px solid #eee; border-radius: 12px; text-decoration: none; color: #0070f3; font-weight: bold; }
</style>