---
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

export async function getStaticPaths() {
  const posts = await client.fetch(`*[_type == "post"]{
    "slug": slug.current,
    "cluster": cluster->slug.current
  }`);
  return posts.map((post) => ({
    params: { cluster: post.cluster || 'sin-categoria', slug: post.slug },
  }));
}

const { slug } = Astro.params;

// 1. CORRECCIÓN DE LA CONSULTA: Traemos metaDescription y mainImage.alt
const post = await client.fetch(`*[_type == "post" && slug.current == $slug][0]{
  title,
  "metaDescription": metaDescription, 
  "h1": title,
  mainImage {
    asset,
    alt
  }, 
  content, 
  "clusterName": cluster->title,
  "clusterSlug": cluster->slug.current
}`, { slug });

if (!post) return Astro.redirect('/404');

const components = {
  block: {
    h2: 'h2',
    h3: 'h3',
    normal: 'p',
  },
  marks: {
    link: (props: any) => {
      const {children, value} = props;
      const isExternal = value.href.startsWith('http');
      const linkProps = {
        href: value.href,
        target: isExternal ? "_blank" : undefined,
        rel: isExternal ? "noopener noreferrer" : undefined,
        className: "text-blue-600 underline font-bold"
      };
      return createElement('a', linkProps, children);
    }
  }
};
---

<Layout 
  title={post.title} 
  description={post.metaDescription || "Lee nuestro artículo sobre SEO Local."}
>
  <article class="post-container">
    <nav class="breadcrumbs">
      <div class="nav-content">
        <a href="/">Inicio</a> 
        <span class="separator">/</span> 
        <a href={`/${post.clusterSlug}`}>{post.clusterName}</a> 
        <span class="separator">/</span> 
        <span class="current">{post.title}</span>
      </div>
    </nav>

    <main class="main-content">
      {post.mainImage && (
        <img 
          src={urlFor(post.mainImage).width(1200).url()} 
          alt={post.mainImage.alt || post.title} 
          class="main-image"
          loading="eager"
        />
      )}

      <header>
        <h1>{post.h1 || post.title}</h1>
        <p class="meta-info">Publicado en <strong>{post.clusterName}</strong></p>
      </header>

      <hr class="divider" />

      <div class="rich-text">
        <PortableText value={post.content} components={components} />
      </div>
    </main>
  </article>
</Layout>

<style>
  .post-container { background: white; min-height: 100vh; }
  .breadcrumbs { background: #f9f9f9; padding: 1rem 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
  .nav-content { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; color: #666; }
  .separator { margin: 0 10px; color: #ccc; }
  .current { color: #999; }

  .main-content { max-width: 800px; margin: 0 auto; padding: 3rem 1.5rem; }
  .main-image { width: 100%; border-radius: 16px; margin-bottom: 2.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.08); object-fit: cover; }
  
  h1 { font-size: clamp(2.2rem, 5vw, 3rem); font-weight: 800; color: #111; line-height: 1.1; margin-bottom: 1.5rem; }
  .divider { border: 0; border-top: 1px solid #eee; margin: 2.5rem 0; }

  .rich-text { line-height: 1.8; font-size: 1.15rem; color: #333; }
  .rich-text :global(h2) { 
    font-size: 1.9rem; 
    font-weight: 700; 
    margin-top: 3rem; 
    margin-bottom: 1.2rem; 
    color: #111;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }
</style>