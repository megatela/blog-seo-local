---
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

// 1. Mantenemos el SSR para Vercel
export const prerender = false;

// 2. Capturamos el slug de la URL
const { slug } = Astro.params;

// 3. Consulta GROQ robusta
// Usamos coalesce para evitar errores si el clúster no está seleccionado en Sanity
const post = await client.fetch(`*[_type == "caseStudy" && slug.current == $slug][0]{
  title,
  metaDescription, 
  "h1": title,
  mainImage, 
  content, 
  "clusterName": coalesce(cluster->title, "Estrategia Local"),
  "clusterSlug": coalesce(cluster->slug.current, "seo-local")
}`, { slug });

// 4. Redirección si el post no existe
if (!post) {
  return Astro.redirect('/404');
}

// 5. Configuración de componentes para el contenido enriquecido
const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { class: 'text-3xl font-bold mt-12 mb-6' }, children),
    h3: ({children}: any) => createElement('h3', { class: 'text-2xl font-bold mt-8 mb-4' }, children),
    normal: ({children}: any) => createElement('p', { class: 'mb-6 text-gray-700 leading-relaxed' }, children),
  },
  marks: {
    link: (props: any) => {
      const {children, value} = props;
      const isExternal = value.href.startsWith('http');
      return createElement('a', {
        href: value.href,
        target: isExternal ? "_blank" : undefined,
        rel: isExternal ? "noopener noreferrer" : undefined,
        class: "text-blue-600 underline font-semibold hover:text-blue-800"
      }, children);
    }
  },
  types: {
    // ESTO ES LO QUE PINTA LA IMAGEN DEL MAPA DE CALOR
    image: ({ value }: any) => {
      if (!value?.asset) return null;
      return createElement('img', {
        src: urlFor(value).width(1000).auto('format').url(),
        alt: value.alt || 'Resultado de SEO Local',
        class: 'rounded-2xl my-10 shadow-xl border border-gray-100 w-full h-auto',
        loading: 'lazy'
      });
    }
  }
};
---

<Layout 
  title={post.title} 
  description={post.metaDescription || "Caso de éxito detallado sobre optimización SEO Local."}
>
  <article class="post-container">
    <nav class="breadcrumbs">
      <div class="nav-content">
        <a href="/" class="hover:text-blue-600 transition">Inicio</a> 
        <span class="separator">/</span> 
        <a href={`/cluster/${post.clusterSlug}`} class="hover:text-blue-600 transition">{post.clusterName}</a> 
        <span class="separator">/</span> 
        <span class="current">{post.title}</span>
      </div>
    </nav>

    <main class="main-content">
      {post.mainImage && (
        <img 
          src={urlFor(post.mainImage).width(1200).url()} 
          alt={post.mainImage.alt || post.title} 
          class="main-image"
          loading="eager"
        />
      )}

      <header class="mb-12">
        <h1 class="text-4xl md:text-5xl font-black text-gray-900 mb-4 leading-tight">
          {post.h1 || post.title}
        </h1>
        <div class="flex items-center gap-2 text-gray-500">
          <span>Especialidad:</span>
          <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider">
            {post.clusterName}
          </span>
        </div>
      </header>

      <hr class="divider" />

      <div class="rich-text">
        <PortableText value={post.content} components={components} />
      </div>
    </main>
  </article>
</Layout>

<style>
  .post-container { background: white; min-height: 100vh; }
  .breadcrumbs { background: #fdfdfd; padding: 1.25rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }
  .nav-content { max-width: 850px; margin: 0 auto; padding: 0 1.5rem; color: #777; }
  .separator { margin: 0 12px; color: #ddd; }
  .current { color: #222; font-weight: 500; }
  .main-content { max-width: 850px; margin: 0 auto; padding: 4rem 1.5rem; }
  .main-image { width: 100%; border-radius: 24px; margin-bottom: 3.5rem; shadow: 0 20px 40px rgba(0,0,0,0.1); }
  .divider { border: 0; border-top: 1px solid #eee; margin: 3rem 0; }
  .rich-text { font-size: 1.2rem; }
  
  /* Selectores globales para el contenido dinámico */
  .rich-text :global(h2) { font-size: 2.25rem; border-left: 5px solid #2563eb; padding-left: 1rem; }
  .rich-text :global(p) { margin-bottom: 1.75rem; color: #374151; }
  .rich-text :global(img) { transition: transform 0.3s ease; }
  .rich-text :global(img:hover) { transform: scale(1.01); }
</style>
