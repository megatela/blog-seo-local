---
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

const { cluster, slug } = Astro.params;

// QUERY: Traemos el post y los relacionados con campos para variar el Anchor Text
const data = await client.fetch(`{
  "post": *[_type == "post" && slug.current == $slug][0]{
    title,
    metaDescription, 
    mainImage, 
    content, 
    "clusterName": cluster->title,
    "clusterSlug": cluster->slug.current
  },
  "related": *[_type == "post" && cluster->slug.current == $cluster && slug.current != $slug][0...3]{
    title,
    slug,
    "anchorText": coalesce(excerpt, metaDescription, title) 
  }
}`, { cluster, slug });

if (!data.post) return Astro.redirect('/404');

const { post, related } = data;

// Configuración de PortableText (Sin cambios aquí para mantener tu diseño)
const components = {
  block: {
    h2: ({children}: any) => createElement('h2', {}, children),
    h3: ({children}: any) => createElement('h3', {}, children),
    normal: ({children}: any) => createElement('p', {}, children),
  }
};
---

<Layout title={post.title} description={post.metaDescription || ""}>
  <article class="post-container">
    <nav class="breadcrumbs">
      <div class="nav-content">
        <a href="/">Inicio</a> / <a href={`/${post.clusterSlug}`}>{post.clusterName}</a> / <span>{post.title}</span>
      </div>
    </nav>

    <main class="main-content">
      {post.mainImage && (
        <img src={urlFor(post.mainImage).width(1200).url()} alt={post.title} class="main-image" />
      )}

      <header>
        <h1 class="text-4xl font-black mb-4 uppercase tracking-tighter">{post.title}</h1>
      </header>

      <hr class="divider" />

      <div class="rich-text">
        <PortableText value={post.content} components={components} />
      </div>

      {related.length > 0 && (
        <section class="related-section">
          <h2 class="related-title">Artículos relacionados <br/> <span>para dominar el SEO Local</span></h2>
          <div class="related-grid">
            {related.map((rel) => (
              <a href={`/${post.clusterSlug}/${rel.slug.current}`} class="related-card">
                <span class="card-tag">Lectura recomendada</span>
                <h3 class="card-title">
                  {/* Si el texto es igual al título, le añadimos contexto para variar el SEO */}
                  {rel.anchorText === rel.title ? `Guía sobre ${rel.title}` : rel.anchorText}
                </h3>
                <span class="card-arrow">Continuar leyendo →</span>
              </a>
            ))}
          </div>
        </section>
      )}
    </main>
  </article>
</Layout>

<style>
  /* Mantenemos tus estilos, asegurando que la sección de relacionados sea limpia */
  .related-section { margin-top: 4rem; padding-top: 3rem; border-top: 2px solid #f0f0f0; }
  .related-title { font-size: 1.8rem; font-weight: 900; text-transform: uppercase; margin-bottom: 2rem; line-height: 1.1; }
  .related-title span { color: #2563eb; }
  .related-grid { display: grid; gap: 1rem; }
  .related-card { background: #f9fafb; padding: 1.5rem; border-radius: 15px; text-decoration: none; transition: 0.3s; border: 1px solid #eee; }
  .related-card:hover { border-color: #2563eb; background: #fff; transform: scale(1.02); }
  .card-tag { font-size: 0.65rem; font-weight: 800; color: #2563eb; text-transform: uppercase; margin-bottom: 0.5rem; display: block; }
  .card-title { font-size: 1.2rem; font-weight: 800; color: #111; margin-bottom: 0.5rem; }
  .card-arrow { font-size: 0.8rem; font-weight: 700; color: #2563eb; }
</style>
