---
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

const { slug } = Astro.params;

// QUERY SIMPLIFICADA: Solo traemos el post actual
let post;
try {
  post = await client.fetch(`*[_type == "post" && slug.current == $slug][0]{
    title,
    metaDescription, 
    mainImage, 
    content, 
    "clusterName": cluster->title,
    "clusterSlug": cluster->slug.current
  }`, { slug });
} catch (e) {
  console.error("Error en Sanity Fetch:", e);
}

if (!post) {
  return Astro.redirect('/404');
}

// CONFIGURACIÃ“N DE COMPONENTES DEL CONTENIDO
const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-3xl md:text-5xl font-black text-slate-900 mt-16 mb-8 uppercase tracking-tighter border-l-8 border-blue-600 pl-6' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-2xl font-bold text-slate-800 mt-12 mb-6' }, children),
    normal: ({children}: any) => createElement('p', { className: 'text-lg md:text-xl text-slate-600 leading-relaxed mb-8' }, children),
  },
  marks: {
    strong: ({children}: any) => createElement('strong', { className: 'font-extrabold text-slate-900' }, children),
    link: ({value, children}: any) => {
      const isExternal = value?.href?.startsWith('http');
      return createElement('a', {
        href: value.href,
        target: isExternal ? "_blank" : undefined,
        rel: isExternal ? "noopener noreferrer" : undefined,
        className: "text-blue-600 underline decoration-blue-200 hover:decoration-blue-600 transition-all font-bold"
      }, children);
    }
  }
};
---

<Layout title={post.title} description={post.metaDescription || "Estrategia de SEO Local"}>
  
  <div class="reading-progress-container">
    <div class="progress-bar" id="readingBar"></div>
  </div>

  <article class="post-wrapper">
    <nav class="post-nav">
      <div class="content-limit">
        <a href="/">Inicio</a> / 
        <a href={`/${post.clusterSlug}`}>{post.clusterName}</a> / 
        <span class="current-crumb">{post.title}</span>
      </div>
    </nav>

    <main class="content-limit">
      {post.mainImage && (
        <div class="image-container">
          <img 
            src={urlFor(post.mainImage).width(1200).url()} 
            alt={post.title} 
            class="main-image-hero" 
          />
        </div>
      )}

      <header class="post-header-info">
        <h1 class="text-4xl md:text-7xl font-black mb-6 uppercase tracking-tighter leading-[0.9] text-slate-900">
          {post.title}
        </h1>
        <p class="text-gray-400 italic text-xl">
          Silo: <span class="text-blue-600 font-bold not-italic">{post.clusterName}</span>
        </p>
      </header>

      <hr class="post-divider" />

      <div class="article-body">
        <PortableText value={post.content} components={components} />
      </div>
    </main>
  </article>

  <script is:inline>
    window.onscroll = function() {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const bar = document.getElementById("readingBar");
      if (bar) bar.style.width = scrolled + "%";
    };
  </script>

</Layout>

<style>
  .post-wrapper { background: white; min-height: 100vh; padding-bottom: 8rem; }
  .content-limit { max-width: 850px; margin: 0 auto; padding: 0 1.5rem; }

  .reading-progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 5px; z-index: 9999; background: transparent; }
  .progress-bar { height: 100%; background: #2563eb; width: 0%; transition: width 0.1s ease-out; }

  .post-nav { background: #fafafa; padding: 1.2rem 0; border-bottom: 1px solid #eee; margin-bottom: 4rem; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #888; }
  .current-crumb { color: #ccc; }

  .image-container { margin-bottom: 4rem; }
  .main-image-hero { width: 100%; border-radius: 40px; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15); object-fit: cover; }
  .post-header-info { text-align: center; margin-bottom: 4rem; }
  .post-divider { border: 0; border-top: 3px solid #f1f5f9; margin: 4rem auto; max-width: 100px; }

  .article-body { text-align: left; }
  .article-body :global(p) { margin-bottom: 2.5rem; }
</style>
