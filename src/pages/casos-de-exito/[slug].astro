---
import { client, urlFor } from '../../lib/sanity'; 
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;
const { slug } = Astro.params;

const caseStudy = await client.fetch(`*[_type == "caseStudy" && slug.current == $slug][0]{
  title,
  metaDescription,
  mainImage { asset, alt },
  content,
  metrics
}`, { slug });

if (!caseStudy) return Astro.redirect('/404');

const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-2xl font-extrabold text-gray-900 mt-10 mb-4' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-xl font-bold text-blue-700 mt-6 mb-3' }, children),
    normal: ({children}: any) => createElement('p', { className: 'text-lg text-gray-700 mb-6 leading-relaxed' }, children),
  },
};
---

<Layout title={caseStudy.title} description={caseStudy.metaDescription}>
  <div id="reading-progress" class="fixed top-0 left-0 h-1.5 bg-blue-600 z-[9999] w-0 transition-all duration-75"></div>

  <article class="bg-white min-h-screen">
    <div class="border-b border-gray-100 py-4">
      <div class="max-w-4xl mx-auto px-6 flex items-center gap-2 text-sm text-gray-500 font-medium">
        <a href="/" class="hover:text-blue-600">Inicio</a>
        <span>›</span>
        <a href="/blog" class="hover:text-blue-600">Blog</a>
        <span>›</span>
        <span class="text-gray-900 truncate">Caso de Éxito</span>
      </div>
    </div>

    <header class="py-12 md:py-20 text-left max-w-4xl mx-auto px-6">
      <span class="text-blue-600 font-bold text-xs uppercase tracking-widest mb-4 block">Resultados Verificados</span>
      <h1 class="text-3xl md:text-5xl font-black text-gray-900 leading-tight mb-6">
        {caseStudy.title}
      </h1>
      <p class="text-xl text-gray-600 font-normal leading-relaxed">
        {caseStudy.metaDescription}
      </p>
    </header>

    <div class="max-w-4xl mx-auto px-6 pb-24">
      {caseStudy.mainImage && (
        <div class="mb-12 rounded-2xl overflow-hidden shadow-xl border border-gray-100">
          <img 
            src={urlFor(caseStudy.mainImage.asset).width(1200).url()} 
            alt={caseStudy.mainImage.alt || caseStudy.title} 
            class="w-full h-auto object-cover"
          />
        </div>
      )}

      {caseStudy.metrics && (
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-16">
          {caseStudy.metrics.map((m: any) => (
            <div class="bg-gray-50 border border-gray-100 p-6 rounded-xl text-center">
              <span class="block text-2xl md:text-3xl font-black text-blue-600 mb-1">{m.value}</span>
              <span class="block text-[10px] uppercase font-bold text-gray-500 tracking-wider">{m.label}</span>
            </div>
          ))}
        </div>
      )}

      <div class="prose prose-blue prose-lg max-w-none">
        <PortableText value={caseStudy.content} components={components} />
      </div>

      <div class="mt-20 p-8 md:p-12 bg-gray-900 rounded-3xl text-center text-white">
        <h2 class="text-2xl md:text-3xl font-bold mb-4">¿Quieres duplicar tus resultados?</h2>
        <p class="text-gray-400 text-lg mb-8 max-w-xl mx-auto font-light">
          Analizamos tu presencia en Google Business Profile y trazamos un plan de acción real.
        </p>
        <a href="/contactame" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-4 rounded-xl transition-all">
          EMPEZAR AHORA <span class="ml-2 text-xl">→</span>
        </a>
      </div>
    </div>
  </article>
</Layout>

<script is:inline>
  // Lógica robusta para la barra de progreso
  const progressLine = document.getElementById('reading-progress');
  
  window.addEventListener('scroll', () => {
    const windowScroll = window.scrollY;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (windowScroll / height) * 100;
    
    if (progressLine) {
      progressLine.style.width = scrolled + '%';
    }
  });
</script>

<style is:global>
  /* Estilos para limpiar el contenido enriquecido */
  .prose blockquote {
    border-left: 4px solid #2563eb !important;
    background: #f8fafc;
    padding: 1.5rem !important;
    border-radius: 0.5rem;
    font-style: italic;
    color: #1e40af !important;
  }
</style>
