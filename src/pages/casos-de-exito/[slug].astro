---
import { client, urlFor } from '../../lib/sanity'; 
import { PortableText } from '@portabletext/react';
import Layout from '../../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;
const { slug } = Astro.params;

const caseStudy = await client.fetch(`*[_type == "caseStudy" && slug.current == $slug][0]{
  title,
  metaDescription,
  mainImage { asset, alt },
  content,
  metrics
}`, { slug });

if (!caseStudy) return Astro.redirect('/404');

const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-2xl font-bold text-gray-900 mt-10 mb-4' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-xl font-bold text-blue-700 mt-6 mb-3' }, children),
    normal: ({children}: any) => createElement('p', { className: 'text-lg text-gray-700 mb-6 leading-relaxed' }, children),
  },
};
---

<Layout title={caseStudy.title} description={caseStudy.metaDescription}>
  <div id="reading-progress" style="position: fixed; top: 0; left: 0; height: 6px; background: #2563eb; z-index: 9999; width: 0%; transition: width 0.1s ease-out;"></div>

  <article class="bg-white min-h-screen">
    <nav class="border-b border-gray-100 py-4 bg-white sticky top-0 z-50">
      <div class="max-w-4xl mx-auto px-6 flex items-center gap-2 text-sm text-gray-500 font-medium">
        <a href="/" class="hover:text-blue-600">Inicio</a>
        <span class="text-gray-300">/</span>
        <a href="/blog" class="hover:text-blue-600">Blog</a>
        <span class="text-gray-300">/</span>
        <span class="text-gray-900 truncate">Caso de Éxito</span>
      </div>
    </nav>

    <header class="py-12 md:py-20 max-w-4xl mx-auto px-6">
      <div class="inline-block px-3 py-1 bg-blue-50 text-blue-700 text-xs font-bold uppercase tracking-widest rounded-md mb-6">
        Resultados Reales
      </div>
      <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 mb-6 leading-tight">
        {caseStudy.title}
      </h1>
      <p class="text-xl text-gray-600 font-light italic border-l-4 border-blue-500 pl-6">
        {caseStudy.metaDescription}
      </p>
    </header>

    <div class="max-w-4xl mx-auto px-6 pb-24">
      {caseStudy.mainImage && (
        <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl">
          <img 
            src={urlFor(caseStudy.mainImage.asset).width(1200).url()} 
            alt={caseStudy.mainImage.alt || caseStudy.title} 
            class="w-full h-auto block"
          />
        </div>
      )}

      {caseStudy.metrics && (
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-16">
          {caseStudy.metrics.map((m: any) => (
            <div class="bg-slate-50 border border-slate-200 p-6 rounded-2xl text-center shadow-sm">
              <span class="block text-3xl font-black text-blue-600 mb-1">{m.value}</span>
              <span class="block text-[11px] uppercase font-bold text-slate-500 tracking-tighter">{m.label}</span>
            </div>
          ))}
        </div>
      )}

      <div class="prose prose-blue prose-lg max-w-none prose-img:rounded-2xl">
        <PortableText value={caseStudy.content} components={components} />
      </div>

      <footer class="mt-20 p-10 md:p-16 bg-blue-600 rounded-[40px] text-center text-white shadow-2xl shadow-blue-200">
        <h2 class="text-3xl font-bold mb-4">¿Quieres resultados similares para tu negocio?</h2>
        <p class="text-blue-100 text-lg mb-10 max-w-xl mx-auto opacity-90">
          Analizamos tu potencial de crecimiento local y trazamos un plan de acción real.
        </p>
        <a href="/contactame" class="inline-flex items-center bg-white text-blue-600 font-bold px-10 py-5 rounded-2xl transition-all hover:scale-105 hover:shadow-xl">
          SOLICITAR AUDITORÍA GRATIS <span class="ml-3 text-2xl" style="line-height: 0;">→</span>
        </a>
      </footer>
    </div>
  </article>
</Layout>

<script is:inline>
  function updateProgress() {
    const bar = document.getElementById('reading-progress');
    if (!bar) return;
    const totalHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const progress = (window.scrollY / totalHeight) * 100;
    bar.style.width = progress + '%';
  }
  window.addEventListener('scroll', updateProgress);
  window.addEventListener('resize', updateProgress);
</script>
