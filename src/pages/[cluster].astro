---
import { client, urlFor } from '../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

const { cluster: slug } = Astro.params;

// 1. QUERY BLINDADA: Pedimos el asset expandido
const data = await client.fetch(
  `{
    "cluster": *[_type == "cluster" && slug.current == $slug][0]{
      title,
      description,
      "mainImage": mainImage.asset->url, // Obtenemos la URL directa para mayor seguridad
      content
    },
    "posts": *[_type == "post" && cluster->slug.current == $slug] | order(_createdAt desc)
  }`,
  { slug }
);

if (!data.cluster) return Astro.redirect('/404');

// Componentes PortableText... (mantén los anteriores)
const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-3xl md:text-4xl font-black text-slate-900 mt-16 mb-6 tracking-tight border-b pb-4' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-2xl font-bold text-slate-800 mt-10 mb-4' }, children),
    normal: ({children}: any) => createElement('p', { className: 'text-lg text-slate-600 leading-relaxed mb-6' }, children),
  }
};
---

<Layout title={data.cluster.title}>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <article class="bg-white min-h-screen">
    <header class="bg-slate-900 pt-24 pb-16 px-6">
      <div class="max-w-4xl mx-auto">
        <nav class="flex items-center space-x-2 text-blue-400 text-sm font-bold uppercase tracking-widest mb-8">
          <a href="/" class="hover:text-white transition">Inicio</a>
          <span>/</span>
          <span class="text-slate-400">Guía Pilar</span>
        </nav>
        
        <h1 class="text-4xl md:text-7xl font-black text-white leading-tight mb-8">
          {data.cluster.title}
        </h1>

        {data.cluster.mainImage ? (
          <div class="relative mt-12">
            <img 
              src={data.cluster.mainImage} 
              alt={data.cluster.title}
              class="rounded-[2rem] shadow-2xl w-full object-cover h-[300px] md:h-[500px]"
            />
          </div>
        ) : (
          /* Caja de depuración por si la imagen sigue fallando */
          <div class="mt-12 p-8 bg-slate-800 rounded-[2rem] border-2 border-dashed border-slate-700 text-slate-500 text-center">
             La imagen no se está cargando. Revisa que el campo 'mainImage' tenga una imagen subida en Sanity.
          </div>
        )}
      </div>
    </header>

    <main class="max-w-4xl mx-auto py-20 px-6">
      <div class="rich-text-container">
        <PortableText value={data.cluster.content} components={components} />
      </div>

      </main>
  </article>
</Layout>