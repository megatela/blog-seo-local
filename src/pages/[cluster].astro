---
import { client, urlFor } from '../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

const { cluster: slug } = Astro.params;

// 1. QUERY ULTRA-PRECISA: Traemos la URL directamente desde el asset
const data = await client.fetch(
  `{
    "cluster": *[_type == "cluster" && slug.current == $slug][0]{
      title,
      description,
      "imageUrl": mainImage.asset->url, 
      content
    },
    "posts": *[_type == "post" && cluster->slug.current == $slug] | order(_createdAt desc)
  }`,
  { slug }
);

if (!data.cluster) return Astro.redirect('/404');

const components = {
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-3xl md:text-4xl font-black text-slate-900 mt-16 mb-6 border-l-4 border-blue-600 pl-4' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-2xl font-bold text-slate-800 mt-10 mb-4' }, children),
    normal: ({children}: any) => createElement('p', { className: 'text-lg text-slate-600 leading-relaxed mb-6' }, children),
  },
  list: {
    bullet: ({children}: any) => createElement('ul', { className: 'space-y-4 mb-8 ml-4' }, children),
  },
  listItem: {
    bullet: ({children}: any) => createElement('li', { className: 'flex items-start text-lg text-slate-600 before:content-["→"] before:text-blue-500 before:mr-3 before:font-bold' }, children),
  },
};
---

<Layout title={data.cluster.title}>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <article class="bg-white min-h-screen font-sans">
    <header class="bg-slate-900 pt-32 pb-20 px-6 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-1/2 h-full bg-blue-600 opacity-5 transform skew-x-12 translate-x-20"></div>
      
      <div class="max-w-4xl mx-auto relative z-10">
        <nav class="flex items-center space-x-2 text-blue-400 text-xs font-black uppercase tracking-widest mb-10">
          <a href="/" class="hover:text-white transition">Inicio</a>
          <span class="text-slate-600">/</span>
          <span class="text-slate-400">Knowledge Base</span>
        </nav>
        
        <h1 class="text-5xl md:text-8xl font-black text-white leading-none mb-10 tracking-tighter">
          {data.cluster.title}
        </h1>

        <div class="relative mt-16">
          {data.cluster.imageUrl ? (
            <div class="rounded-[2.5rem] overflow-hidden shadow-2xl border-4 border-slate-800">
              <img 
                src={data.cluster.imageUrl} 
                alt={data.cluster.title}
                class="w-full h-[350px] md:h-[550px] object-cover"
                onerror="this.style.display='none'; document.getElementById('image-error').style.display='flex';"
              />
            </div>
          ) : (
            <div class="h-[300px] bg-slate-800 rounded-[2.5rem] flex items-center justify-center border-2 border-dashed border-slate-700 text-slate-500 font-bold">
               Imagen no encontrada en Sanity
            </div>
          )}
          <div id="image-error" class="hidden h-[300px] bg-red-50 rounded-[2.5rem] items-center justify-center text-red-500 font-bold border-2 border-red-200">
             Error cargando el archivo de imagen
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto py-24 px-6">
      <div class="prose prose-blue max-w-none">
        <PortableText value={data.cluster.content} components={components} />
      </div>

      <section class="mt-40">
        <div class="flex items-end justify-between mb-16 border-b-2 border-slate-100 pb-8">
          <h2 class="text-4xl font-black text-slate-900 tracking-tighter uppercase">Deep Dive Articles</h2>
          <span class="text-blue-600 font-black text-sm uppercase tracking-widest hidden md:block">Contenido Especializado</span>
        </div>

        {data.posts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            {data.posts.map((post) => (
              <a href={`/${slug}/${post.slug.current}`} class="group relative bg-slate-50 p-10 rounded-[2rem] transition-all duration-500 hover:bg-white hover:shadow-2xl border border-transparent hover:border-slate-100">
                <div class="absolute top-6 right-8 text-slate-200 group-hover:text-blue-100 transition-colors">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5c-1.11 0-2 .89-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7h-2v7z"/></svg>
                </div>
                <h3 class="text-2xl font-black text-slate-800 group-hover:text-blue-600 mb-6 leading-tight">
                  {post.title}
                </h3>
                <p class="text-slate-500 leading-relaxed mb-8">Guía técnica detallada para dominar este aspecto del SEO Local en 2026.</p>
                <div class="inline-flex items-center text-blue-600 font-black text-xs uppercase tracking-[0.2em]">
                  Explorar ahora <span class="ml-3 transform group-hover:translate-x-2 transition-transform">→</span>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="bg-slate-900 p-16 rounded-[3rem] text-center shadow-xl">
             <p class="text-slate-400 text-lg font-bold mb-4">Módulo en construcción</p>
             <p class="text-white text-2xl font-black">Estamos preparando contenido de alto nivel para este clúster.</p>
          </div>
        )}
      </section>
    </main>
  </article>
</Layout>