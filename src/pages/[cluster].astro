---
import { client, urlFor } from '../lib/sanity';
import { PortableText } from '@portabletext/react';
import Layout from '../layouts/Layout.astro';
import { createElement } from 'react';

export const prerender = false;

const { cluster: slug } = Astro.params;

// 1. Query refinada para asegurar que traemos la imagen de portada correctamente
const data = await client.fetch(
  `{
    "cluster": *[_type == "cluster" && slug.current == $slug][0]{
      title,
      description,
      "mainImage": mainImage.asset->url, 
      content
    },
    "posts": *[_type == "post" && cluster->slug.current == $slug] | order(_createdAt desc)
  }`,
  { slug }
);

if (!data.cluster) return Astro.redirect('/404');

// 2. Configuración avanzada de componentes para PortableText
const components = {
  types: {
    image: ({ value }: any) => {
      return createElement('img', {
        src: urlFor(value).width(800).url(),
        alt: value.alt || 'Imagen de contenido',
        className: 'rounded-xl my-8 shadow-md w-full'
      });
    }
  },
  block: {
    h2: ({children}: any) => createElement('h2', { className: 'text-3xl font-bold mt-12 mb-6' }, children),
    h3: ({children}: any) => createElement('h3', { className: 'text-2xl font-bold mt-8 mb-4' }, children),
    normal: ({children}: any) => createElement('p', { className: 'mb-6 text-gray-700 leading-relaxed' }, children),
  }
};
---

<Layout title={data.cluster.title}>
  <article class="max-w-4xl mx-auto py-12 px-6">
    <nav class="text-sm text-gray-500 mb-8 font-medium">
      <a href="/" class="hover:text-blue-600 transition">Inicio</a> 
      <span class="mx-2">/</span> 
      <span class="text-gray-900">{data.cluster.title}</span>
    </nav>

    <header class="mb-12">
      <h1 class="text-4xl md:text-6xl font-black mb-8 leading-tight text-gray-900">
        {data.cluster.title}
      </h1>
      
      {data.cluster.mainImage && (
        <div class="relative w-full h-[400px] mb-12">
          <img 
            src={data.cluster.mainImage} 
            alt={data.cluster.title}
            class="w-full h-full object-cover rounded-3xl shadow-2xl"
          />
        </div>
      )}
    </header>

    <section class="rich-text mb-24">
      <PortableText value={data.cluster.content} components={components} />
    </section>

    <div class="border-t border-gray-200 pt-16">
        <h2 class="text-3xl font-black mb-10 text-gray-800 tracking-tight">
            Artículos Relacionados en {data.cluster.title}
        </h2>
        
        {data.posts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {data.posts.map((post) => (
              <a href={`/${slug}/${post.slug.current}`} class="group p-8 bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-xl hover:border-blue-500 transition-all duration-300">
                <h3 class="text-xl font-bold group-hover:text-blue-600 mb-3 transition-colors">{post.title}</h3>
                <p class="text-gray-500 text-sm leading-relaxed mb-4 line-clamp-2">
                    Estrategia detallada sobre {post.title.toLowerCase()} para dominar el Local Pack.
                </p>
                <span class="text-blue-600 font-bold text-xs uppercase tracking-widest">Ver Artículo →</span>
              </a>
            ))}
          </div>
        ) : (
          <div class="bg-gray-50 p-10 rounded-2xl text-center border-2 border-dashed border-gray-200 text-gray-400">
             Próximamente compartiremos más contenido en este pilar.
          </div>
        )}
    </div>
  </article>
</Layout>

<style>
  /* Estilos específicos para el texto de Sanity */
  .rich-text :global(p) { font-size: 1.15rem; }
  .rich-text :global(strong) { color: #111; font-weight: 800; }
  .rich-text :global(ul) { list-style: disc; margin-left: 1.5rem; margin-bottom: 2rem; }
  .rich-text :global(li) { margin-bottom: 0.75rem; color: #374151; }
</style>