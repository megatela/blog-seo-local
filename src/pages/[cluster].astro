---
import { client } from '../lib/sanity';
import Layout from '../layouts/Layout.astro';

export const prerender = false;
const { cluster } = Astro.params;

// Query para obtener el cl√∫ster y sus posts
const data = await client.fetch(`*[_type == "cluster" && slug.current == $cluster][0]{
  title,
  description,
  "posts": *[_type == "post" && references(^._id)]{
    title,
    slug,
    metaDescription
  }
}`, { cluster });

if (!data) return Astro.redirect('/404');
---

<Layout title={data.title} description={data.description}>
  
  <div class="reading-progress-container">
    <div class="progress-bar" id="readingBar"></div>
  </div>

  <main class="content-limit py-20">
    <header class="mb-16">
      <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none mb-6">
        {data.title}
      </h1>
      <p class="text-xl text-slate-600 max-w-2xl">{data.description}</p>
    </header>

    <div class="grid gap-8">
      {data.posts.map((post: any) => (
        <a href={`/${cluster}/${post.slug.current}`} class="group p-8 bg-slate-50 rounded-3xl border-2 border-transparent hover:border-blue-600 hover:bg-white transition-all">
          <h2 class="text-2xl font-bold mb-2 group-hover:text-blue-600">{post.title}</h2>
          <p class="text-slate-500">{post.metaDescription}</p>
        </a>
      ))}
    </div>
  </main>

  <script is:inline>
    window.onscroll = function() {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const bar = document.getElementById("readingBar");
      if (bar) bar.style.width = scrolled + "%";
    };
  </script>
</Layout>

<style>
  .content-limit { max-width: 850px; margin: 0 auto; padding: 0 1.5rem; }
  
  /* ESTILOS DE LA BARRA (Copiados exactamente de los posts para consistencia) */
  .reading-progress-container { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 6px; 
    z-index: 9999; 
    background: #f1f5f9; 
  }
  .progress-bar { 
    height: 100%; 
    background: #2563eb; 
    width: 0%; 
    transition: width 0.1s ease-out; 
  }
</style>
